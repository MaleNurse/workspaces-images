#!/bin/bash

export HOME="/home/kasm-user"
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"
umask 022

# Correct permissions/ownership
chmod 755 $HOME
chmod 644 $HOME/.aliases $HOME/.bashrc
find $HOME/.config -type f | xargs chmod 644
find $HOME/.config -type d | xargs chmod 755
find $HOME/.local -type d | xargs chmod 755
chmod 755 $HOME/Desktop
chmod 755 $HOME/bin
chmod 755 $HOME/.cargo
chmod 755 $HOME/logs

# Try to install Neovim and Neovide
have_nvim=$(type -p nvim)
have_neov=$(type -p neovide)

[ "${have_nvim}" ] || {
  [ -x $HOME/bin/install-neovim ] && {
    xfce4-terminal --title "Install Neovim" --command "${HOME}/bin/install-neovim; exit"
  }
}

[ "${have_neov}" ] || {
  [ -x $HOME/bin/install-neovide ] && {
    xfce4-terminal --title "Install Neovide" --command "${HOME}/bin/install-neovide; exit"
  }
}

have_nvim=$(type -p nvim)
have_neov=$(type -p neovide)

# We gave it our best shot
[ "${have_nvim}" ] && {
  rm -f /home/*/bin/install-neovim
}
[ "${have_neov}" ] && {
  rm -f /home/*/bin/install-neovide
}

[ -f $HOME/.config/autostart/postinstall.desktop ] && {
  rm -f $HOME/.config/autostart/postinstall.desktop
}

have_lazy=$(type -p lazyman)
[ "${have_lazy}" ] && {
  xfce4-terminal --title Lazyman --command "lazyman -z noinstall; exit"
}

[ -f $HOME/.config/nvim-Lazyman/.initialized ] || {
  [ -f $HOME/.local/share/applications/lazyman-install.desktop ] && {
    cp $HOME/.local/share/applications/lazyman-install.desktop \
       $HOME/.config/autostart/lazyman.desktop
  }
}
